{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Müşteri Geçmişi: {{ customer.name }}</h2>

    <div class="alert alert-warning">
        <strong>Borç (Açık Veresiye):</strong> {{ open_credit | round(2) }} ₺
    </div>

    <hr>

    <h4>Satışlar</h4>
    {% if sales %}
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Tutar</th>
                    <th>Ödeme Tipi</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in sales %}
                <tr>
                    <td>{{ sale.sale_date }}</td>
                    <td>{{ sale.total_amount }} ₺</td>
                    <td>{{ sale.payment_type }}</td>
                    <td>
                        {% if sale.payment_type == "Veresiye" and sale.is_paid == 0 %}
                            <span class="badge bg-danger">Borç</span>
                        {% else %}
                            <span class="badge bg-success">Ödendi</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Satış bulunamadı.</p>
    {% endif %}

    <hr>

    <h4>İadeler</h4>
    {% if returns %}
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Tutar</th>
                    <th>Detay</th>
                </tr>
            </thead>
            <tbody>
                {% for r in returns %}
                <tr>
                    <td>{{ r.return_date }}</td>
                    <td>{{ r.total_amount }} ₺</td>
                    <td>{{ r.details }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>İade bulunamadı.</p>
    {% endif %}

    <a href="{{ url_for('customer') }}" class="btn btn-secondary mt-3">Geri</a>
</div>
{% endblock %}
<div style="margin-top:10px; padding:8px; border:1px solid #eee; border-radius:8px">
  <b>Tahsilat Yap</b>
  <div style="display:flex; gap:8px; margin-top:6px; flex-wrap:wrap">
    <input id="pay_amount" type="number" step="0.01" placeholder="Tutar">
    <select id="pay_method">
      <option value="cash">Nakit</option>
      <option value="card">Kart</option>
      <option value="transfer">Havale</option>
    </select>
    <input id="pay_notes" placeholder="Not (opsiyonel)">
    <button onclick="collectPayment()">Kaydet</button>
  </div>
  <small style="color:#666">Tahsilat yapınca borç düşer ve ciroya eklenir.</small>
</div>

<script>
async function collectPayment(){
  const amt = parseFloat(document.getElementById('pay_amount').value||'0');
  const method = document.getElementById('pay_method').value;
  const notes  = document.getElementById('pay_notes').value||'';
  if(!(amt>0)){ alert('Tutar > 0 olmalı'); return; }
  const res = await fetch('/api/payment', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      customer_id: {{ customer.id }},
      amount: amt,
      method: method,
      notes: notes
    })
  });
  const js = await res.json().catch(()=>({ok:false,error:'JSON'}));
  if(!js.ok){ alert('Hata: '+(js.error||'tahsilat')); return; }
  location.reload();
}
</script>
