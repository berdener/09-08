<!doctype html><html lang="tr">
<head>
  <meta charset="utf-8">
  <title>İade / Değişim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,Arial;margin:16px}
    input,button,select{padding:.5rem;border:1px solid #ccc;border-radius:8px}
    table{border-collapse:collapse;width:100%;margin-top:10px}
    td,th{border:1px solid #ddd;padding:6px;text-align:left}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .box{border:1px solid #eee;padding:10px;border-radius:8px}
  </style>
  <script>
    let exCart=[];
    function fmt(x){return (Math.round(x*100)/100).toFixed(2);}

    function recalc(){
      let retSub=0;
      document.querySelectorAll('input[data-sale-item-id]').forEach(inp=>{
        const qty=parseInt(inp.value||'0',10);
        const unit=parseFloat(inp.dataset.unit||'0');
        const lt=Math.max(0,qty)*unit;
        retSub+=lt;
        const td=inp.closest('tr').querySelector('[data-line-total]');
        if(td) td.textContent=fmt(lt);
      });

      let exSub=exCart.reduce((s,it)=>s+it.qty*it.price,0);
      const rate=parseFloat((document.getElementById('tax_rate').value||'0').replace(',', '.'))||0;
      const taxableBase=Math.max(exSub-retSub,0);
      const tax=taxableBase*rate;
      const exTotal=taxableBase+tax;
      const net=exSub-retSub;

      document.getElementById('retSub').textContent=fmt(retSub);
      document.getElementById('exSub').textContent=fmt(exSub);
      document.getElementById('tax').textContent=fmt(tax);
      document.getElementById('exTotal').textContent=fmt(exTotal);
      document.getElementById('net').textContent=fmt(net);
    }

    function renderEx(){
      const tb=document.getElementById('tbodyEx'); tb.innerHTML='';
      exCart.forEach((it,i)=>{
        tb.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${it.title}</td>
            <td>${it.sku||''}</td>
            <td>${it.barcode||''}</td>
            <td><input type="number" min="1" value="${it.qty}" onchange="chgEx(${i}, this.value)"></td>
            <td>${fmt(it.price)}</td>
            <td>${fmt(it.qty*it.price)}</td>
            <td><button type="button" onclick="delEx(${i})">Sil</button></td>
          </tr>`);
      });
      recalc();
    }
    function chgEx(i,v){ exCart[i].qty=Math.max(1,parseInt(v||'1',10)); renderEx(); }
    function delEx(i){ exCart.splice(i,1); renderEx(); }

    async function scan(e){
      e&&e.preventDefault();
      const code=document.getElementById('code').value.trim();
      const qty=parseInt(document.getElementById('qty').value||'1',10);
      if(!code) return;
      const res=await fetch('/api/scan?code='+encodeURIComponent(code));
      const js=await res.json();
      if(!js.ok){ alert(js.error||'Bulunamadı'); return; }
      const v=js.variant;
      const ex=exCart.find(x=>x.id===v.id);
      if(ex){ ex.qty+=qty; }
      else{
        exCart.push({
          id:v.id, title:(v.product_title||'')+' / '+(v.title||''),
          sku:v.sku, barcode:v.barcode, inventory_item_id:v.inventory_item_id,
          price:parseFloat(v.price||0), qty:qty
        });
      }
      document.getElementById('code').value=''; document.getElementById('qty').value='1';
      renderEx();
    }

    async function submitReturn(e){
      e.preventDefault();
      const sale_id={{ sale.id }};
      const payment=document.getElementById('payment').value;
      const notes=document.getElementById('notes').value.trim();
      const return_lines=[];
      document.querySelectorAll('input[data-sale-item-id]').forEach(inp=>{
        const qty=parseInt(inp.value||'0',10);
        if(qty>0){ return_lines.push({ sale_item_id: parseInt(inp.dataset.saleItemId||inp.getAttribute('data-sale-item-id'),10), qty }); }
      });

      const body={ sale_id, payment_method:payment, notes, return_lines, exchange_cart:exCart };
      const res = await fetch('/api/return', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  credentials: 'same-origin',   // <— BUNU EKLE
  body: JSON.stringify(body)
});
      const js=await res.json();
      if(!js.ok){ alert('Hata: '+(js.error||'iade')); return; }
      const s=js.summary||{};
      alert('Kaydedildi.\nNet: '+(s.net?.toFixed?s.net.toFixed(2):s.net));
      window.location.href='/sales';
    }
  </script>
</head>
<body onload="recalc()">
  <h2>İade / Değişim — Satış #{{ sale.id }}</h2>
  <div>Satış tarihi: {{ sale.ts }} — Müşteri ID: {{ sale.customer_id }}</div>

  <h3>1) İade Edilecek Satırlar</h3>
  <div class="box">
    <table>
      <tr><th>Ürün</th><th>SKU</th><th>Barkod</th><th>Satılan</th><th>İade</th><th>Birim</th><th>Ara Toplam</th></tr>
      {% for it in items %}
      <tr>
        <td>{{ it.title }}</td>
        <td>{{ it.sku or '' }}</td>
        <td>{{ it.barcode or '' }}</td>
        <td>{{ it.qty }}</td>
        <td><input type="number" min="0" max="{{ it.qty }}" value="0"
                   data-sale-item-id="{{ it.id }}" data-unit="{{ '%.2f'|format(it.unit_price) }}" oninput="recalc()"></td>
        <td>{{ '%.2f'|format(it.unit_price) }}</td>
        <td data-line-total>0.00</td>
      </tr>
      {% endfor %}
    </table>
  </div>

  <h3>2) Değişim İçin Yeni Ürünler (Opsiyonel)</h3>
  <div class="box">
    <form onsubmit="scan(event)" class="row">
      <input id="code" placeholder="Barkod">
      <input id="qty" type="number" min="1" value="1">
      <button type="submit">Ekle</button>
      <span>Vergi oranı: <input id="tax_rate" type="number" step="0.01" value="{{ tax_rate or 0 }}" oninput="recalc()"> (örn. 0.18)</span>
    </form>
    <table>
      <tr><th>Ürün</th><th>SKU</th><th>Barkod</th><th>Adet</th><th>Birim</th><th>Ara Toplam</th><th></th></tr>
      <tbody id="tbodyEx"></tbody>
    </table>
  </div>

  <h3>Özet</h3>
  <div class="box">
    <div class="row">
      <div>İade Ara Toplam: <b><span id="retSub">0.00</span></b></div>
      <div>Değişim Ara Toplam: <b><span id="exSub">0.00</span></b></div>
      <div>Vergi (yalnız değişim için): <b><span id="tax">0.00</span></b></div>
      <div>Değişim Toplam (Vergi dahil): <b><span id="exTotal">0.00</span></b></div>
      <div>Net: <b><span id="net">0.00</span></b> <span style="color:#666">( + tahsil / − iade )</span></div>
    </div>
    <div class="row">
      <select id="payment">
        <option value="cash">Nakit</option>
        <option value="card">Kart</option>
        <option value="transfer">Havale</option>
      </select>
      <input id="notes" placeholder="Not (opsiyonel)">
      <button onclick="submitReturn(event)">İşlemi Kaydet</button>
      <a href="/sales" style="margin-left:auto">← Satışlar</a>
    </div>
  </div>
</body>
</html>
